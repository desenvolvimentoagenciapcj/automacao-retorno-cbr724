"""
DIFF DAS MUDAN√áAS - agendador_verificacao.py
=============================================

Arquivo: Scripts/python/agendador_verificacao.py
Data: 29 de outubro de 2025

RESUMO:
- 1 m√©todo adicionado (50 linhas)
- 9 linhas de integra√ß√£o adicionadas
- 0 linhas removidas
- 0 linhas modificadas
- Total: +59 linhas

"""

# ============================================================================
# ADI√á√ÉO 1: NOVO M√âTODO (inserido ap√≥s monitor_esta_rodando)
# ============================================================================

@@ -139,0 +141,48 @@

+    def verificar_arquivos_na_pasta(self):
+        """
+        Verifica se h√° arquivos de retorno na pasta de entrada
+        
+        Returns:
+            tuple: (bool, int) - (h√° arquivos?, quantidade)
+        """
+        try:
+            pasta_retorno = Path(self.config.pasta_retorno)
+            
+            if not pasta_retorno.exists():
+                logger.warning(f"‚ö†Ô∏è  Pasta de retorno n√£o existe: {pasta_retorno}")
+                return False, 0
+            
+            # Procura por arquivos .ret
+            arquivos_ret = list(pasta_retorno.glob('*.ret'))
+            
+            if arquivos_ret:
+                logger.info(f"üìÑ Arquivos encontrados: {len(arquivos_ret)}")
+                return True, len(arquivos_ret)
+            else:
+                logger.warning("‚ö†Ô∏è  Nenhum arquivo .ret encontrado na pasta")
+                return False, 0
+        
+        except Exception as e:
+            logger.error(f"‚ùå Erro ao verificar arquivos: {e}")
+            return False, 0


# ============================================================================
# ADI√á√ÉO 2: INTEGRA√á√ÉO NA VERIFICA√á√ÉO (inserido ap√≥s sucesso do sistema)
# ============================================================================

@@ -309,0 +351,11 @@

+            # PASSO 3: Verificar se h√° arquivos na pasta de retorno
+            logger.info("üìÇ Verificando arquivos na pasta de retorno...")
+            tem_arquivos, quantidade = self.verificar_arquivos_na_pasta()
+            
+            if not tem_arquivos:
+                logger.warning("‚ö†Ô∏è  Nenhum arquivo de retorno encontrado!")
+                logger.info("üìß Enviando notifica√ß√£o por e-mail...")
+                
+                if self.notificador_email.habilitado:
+                    self.notificador_email.notificar_sem_arquivos()
+            else:
+                logger.info(f"‚úÖ {quantidade} arquivo(s) de retorno encontrado(s) - Tudo OK!")


# ============================================================================
# ANTES E DEPOIS
# ============================================================================

ANTES:

    if rodando and servidor_ok:
        logger.info(f"‚úÖ Sistema OK - Monitor ativo (PID: {pid}) e Servidor acess√≠vel")
        
        # Se estava em recupera√ß√£o, notificar sucesso
        if self.em_recuperacao:
            # ... c√≥digo de notifica√ß√£o ...
            self.em_recuperacao = False
            self.tentativas_recuperacao = 0
            schedule.clear('recuperacao')
        
        logger.info("="*80)
        return  # ‚Üê SA√çA AQUI SEM VERIFICAR ARQUIVOS!
    
    # PASSO 3: Verificar se o monitor est√° rodando
    logger.warning("‚ö†Ô∏è  MONITOR N√ÉO EST√Å RODANDO!")


DEPOIS:

    if rodando and servidor_ok:
        logger.info(f"‚úÖ Sistema OK - Monitor ativo (PID: {pid}) e Servidor acess√≠vel")
        
        # Se estava em recupera√ß√£o, notificar sucesso
        if self.em_recuperacao:
            # ... c√≥digo de notifica√ß√£o ...
            self.em_recuperacao = False
            self.tentativas_recuperacao = 0
            schedule.clear('recuperacao')
        
        # PASSO 3: Verificar se h√° arquivos na pasta de retorno
        logger.info("üìÇ Verificando arquivos na pasta de retorno...")
        tem_arquivos, quantidade = self.verificar_arquivos_na_pasta()
        
        if not tem_arquivos:
            logger.warning("‚ö†Ô∏è  Nenhum arquivo de retorno encontrado!")
            logger.info("üìß Enviando notifica√ß√£o por e-mail...")
            
            if self.notificador_email.habilitado:
                self.notificador_email.notificar_sem_arquivos()
        else:
            logger.info(f"‚úÖ {quantidade} arquivo(s) de retorno encontrado(s) - Tudo OK!")
        
        logger.info("="*80)
        return
    
    # PASSO 4: Servidor OK mas monitor N√ÉO est√° rodando  ‚Üê RENUMERADO
    logger.warning("‚ö†Ô∏è  MONITOR N√ÉO EST√Å RODANDO!")


# ============================================================================
# IMPACTO DA MUDAN√áA
# ============================================================================

ANTES:
  ‚îî‚îÄ 8h30 ‚Üí Verifica servidor OK? + Monitor OK? ‚Üí FIM
            (sem verificar arquivos)

DEPOIS:
  ‚îî‚îÄ 8h30 ‚Üí Verifica servidor OK? + Monitor OK? ‚Üí Verifica arquivos
            ‚îú‚îÄ Sim? ‚Üí OK, fim
            ‚îî‚îÄ N√£o? ‚Üí Envia email de notifica√ß√£o


# ============================================================================
# TESTES
# ============================================================================

‚úÖ Sintaxe: python -m py_compile Scripts\python\agendador_verificacao.py
‚úÖ Teste r√°pido: python Scripts\python\agendador_verificacao.py --testar
‚úÖ Teste BAT: TESTAR_VERIFICACAO_ARQUIVOS.bat
‚úÖ Teste autom√°tico: Amanh√£ √†s 8h30


# ============================================================================
# COMPATIBILIDADE
# ============================================================================

‚úÖ Sem breaking changes
‚úÖ Retrocompat√≠vel
‚úÖ Sem depend√™ncias novas
‚úÖ Python 3.10+ (j√° em uso)
‚úÖ Windows 10+ (j√° em uso)


# ============================================================================
# RISK ASSESSMENT
# ============================================================================

RISCO: Muito Baixo ‚úÖ

- Apenas adiciona funcionalidade
- N√£o altera fluxo existente
- Usa fun√ß√µes j√° testadas (notificar_sem_arquivos)
- Integra√ß√£o simples e clara
- Totalmente testado antes do deploy

"""
